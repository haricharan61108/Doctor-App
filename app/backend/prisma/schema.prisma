// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Patient {
  id        String  @id @default(uuid())
  googleId  String? @unique
  email     String  @unique
  name      String?
  avatarUrl String?
  phone     String?

  appointments  Appointment[]
  prescriptions Prescription[]
  uploadedFiles PatientFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Doctor {
  id             String  @id @default(uuid())
  email          String  @unique
  password       String
  name           String
  specialization String?
  avatarUrl      String?

  timings       DoctorTiming[]
  appointments  Appointment[]
  prescriptions Prescription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Pharmacy {
  id       String  @id @default(uuid())
  email    String  @unique
  password String
  name     String
  address  String?
  phone    String?

  prescriptions Prescription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -------------------------
// FILE UPLOADS (PDF only)
// -------------------------

model PatientFile {
  id        String  @id @default(uuid())
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String

  fileName String // Original filename
  fileUrl  String // Storage URL
  fileType String @default("application/pdf") // Validate PDF
  fileSize Int? // In bytes

  uploadedAt DateTime @default(now())

  @@index([patientId])
}

// -------------------------
// DOCTOR TIMINGS (Fixed: removed date confusion)
// -------------------------

model DoctorTiming {
  id       String @id @default(uuid())
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  doctorId String

  startTime DateTime // Full timestamp: 2025-12-25T09:00:00
  endTime   DateTime // Full timestamp: 2025-12-25T17:00:00
  isBooked  Boolean  @default(false) // Track if slot is booked

  createdAt DateTime @default(now())

  @@index([doctorId])
  @@index([startTime]) // For querying available slots
}

model Appointment {
  id        String  @id @default(uuid())
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String

  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  doctorId String

  scheduledAt DateTime // Renamed from 'time' for clarity
  duration    Int               @default(30) // Duration in minutes
  status      AppointmentStatus @default(BOOKED)

  prescriptions Prescription[] // Link prescriptions to appointments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([doctorId])
  @@index([scheduledAt])
}

enum AppointmentStatus {
  BOOKED
  COMPLETED
  CANCELLED
}

model Prescription {
  id String @id @default(uuid())

  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String

  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  doctorId String

  pharmacy   Pharmacy? @relation(fields: [pharmacyId], references: [id], onDelete: SetNull)
  pharmacyId String?

  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  appointmentId String?

  content String             @db.Text // Prescription details
  pdfUrl  String? // Generated PDF
  status  PrescriptionStatus @default(PENDING)

  issuedAt    DateTime? // When doctor finalizes (status → READY_FOR_PICKUP)
  dispensedAt DateTime? // When patient picks up (status → PURCHASED)
  expiresAt   DateTime? // Auto-set to issuedAt + 2 days

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([doctorId])
  @@index([pharmacyId])
  @@index([appointmentId])
  @@index([status])
  @@index([expiresAt]) // Critical for cleanup job
}

enum PrescriptionStatus {
  PENDING // Doctor is writing
  READY_FOR_PICKUP // Doctor finalized, sent to pharmacy
  PURCHASED // Patient picked up
  EXPIRED // Auto-expired after 2 days
  CANCELLED
}
