// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Patient {
  id        String  @id @default(uuid())
  googleId  String? @unique
  email     String  @unique
  name      String?
  avatarUrl String?
  phone     String?

  appointments  Appointment[]
  prescriptions Prescription[]
  uploadedFiles PatientFile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Doctor {
  id             String  @id @default(uuid())
  email          String  @unique
  password       String
  name           String
  specialization String?
  avatarUrl      String?

  timings       DoctorTiming[]
  appointments  Appointment[]
  prescriptions Prescription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Pharmacy {
  id       String  @id @default(uuid())
  email    String  @unique
  password String
  name     String
  address  String?
  phone    String?

  prescriptions Prescription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -------------------------
// FILE UPLOADS (PDF only)
// -------------------------

model PatientFile {
  id        String  @id @default(uuid())
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String

  fileName String
  fileUrl  String 
  fileType String @default("application/pdf") 
  fileSize Int? 

  uploadedAt DateTime @default(now())

  @@index([patientId])
}

// -------------------------
// DOCTOR TIMINGS (Fixed: removed date confusion)
// -------------------------

model DoctorTiming {
  id       String @id @default(uuid())
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  doctorId String

  startTime DateTime 
  endTime   DateTime 
  isBooked  Boolean  @default(false) 

  createdAt DateTime @default(now())

  @@index([doctorId])
  @@index([startTime]) 
}

model Appointment {
  id        String  @id @default(uuid())
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String

  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  doctorId String

  scheduledAt DateTime 
  duration    Int               @default(30) 
  status      AppointmentStatus @default(BOOKED)

  prescriptions Prescription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([doctorId])
  @@index([scheduledAt])
}

enum AppointmentStatus {
  BOOKED
  COMPLETED
  CANCELLED
}

model Prescription {
  id String @id @default(uuid())

  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId String

  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  doctorId String

  pharmacy   Pharmacy? @relation(fields: [pharmacyId], references: [id], onDelete: SetNull)
  pharmacyId String?

  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  appointmentId String?

  content String             @db.Text 
  pdfUrl  String? 
  status  PrescriptionStatus @default(PENDING)

  issuedAt    DateTime? 
  dispensedAt DateTime? 
  expiresAt   DateTime? 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([doctorId])
  @@index([pharmacyId])
  @@index([appointmentId])
  @@index([status])
  @@index([expiresAt]) 
}

enum PrescriptionStatus {
  PENDING 
  READY_FOR_PICKUP 
  PURCHASED 
  EXPIRED 
  CANCELLED
}
